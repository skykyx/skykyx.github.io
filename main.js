function forEach(e,t){if(!e)return!1;for(let n=0,a=e.length;n<a;n++)if(null!=e[n]&&t(e[n],n))return!0;return!1}const targetRefMap$1=new WeakMap,register$1=new FinalizationRegistry((e=>{e.destroy()}));class HookBindCallback{info=null;cbRef=null;callback=null;constructor(e,t){this.info=e,this.cbRef=new WeakRef(t),this.callback=t,e.addHook(this)}emit(){let e=this.cbRef.deref();if(e)try{e(this.info.getValue())}catch(e){console.error(e)}}destroy(){this.info.removeHook(this),register$1.unregister(this)}bindDestroy(e){let t=targetRefMap$1.get(e);return null==t&&(t=new Set,targetRefMap$1.set(e,t)),t.add(this.callback),this.callback=null,register$1.register(e,this,this),this}}class HookBindValue{info=null;targetRef=null;targetKey="";constructor(e,t,n){this.info=e,this.targetRef=new WeakRef(t),this.targetKey=n,e.addHook(this),register$1.register(t,this,this)}emit(){let e=this.targetRef.deref();if(null!=e)try{e[this.targetKey]=this.info.getValue()}catch(e){console.error(e)}}destroy(){this.info.removeHook(this),register$1.unregister(this)}}class HookBindInfo{proxyObj=null;srcObj=null;keys=[];hookMap=null;ctFunc=null;constructor(e,t,n,a,i){this.proxyObj=e,this.srcObj=t,this.keys=n,this.hookMap=a,this.ctFunc=i}getValue(){return this.ctFunc?this.ctFunc(...this.keys.map((e=>this.srcObj[e]))):this.srcObj[this.keys[0]]}addHook(e){this.keys.forEach((t=>{let n=this.hookMap.get(t);null==n&&(n=new Set,this.hookMap.set(t,n)),n.add(e)}))}removeHook(e){this.keys.forEach((t=>{let n=this.hookMap.get(t);n&&(n.delete(e),0==n.size&&this.hookMap.delete(t))}))}bindToValue(e,t){return new HookBindValue(this,e,t)}bindToCallback(e){return new HookBindCallback(this,e)}}class NAsse{callback=null;constructor(e){this.callback=e}apply(e){this.callback(e)}}class NAttr{key=null;value=null;constructor(e,t){this.key=e,this.value=t}apply(e){if("function"==typeof this.value){let t=this.value(e);null!=t&&e.element.setAttribute(this.key,t)}else e.element.setAttribute(this.key,this.value)}}class NEvent{eventName=null;callback=null;constructor(e,t){this.eventName=e,this.callback=t}apply(e){e.addEventListener(this.eventName,(t=>{this.callback(t,e)}))}}class NStyle{key=null;value=null;constructor(e,t){this.key=e,this.value=t}apply(e){e.setStyle(this.key,this.value)}}function createNStyleList(e){return NList.flat(Object.keys(e).map((t=>new NStyle(t,e[t]))))}class NTagName{tagName=null;constructor(e){this.tagName=e.toLowerCase()}}class NList{list=null;flatFlag=!1;constructor(e){this.list=e}apply(e){const t=e.getTagName();this.list.forEach((n=>{if(null!=n)if("string"==typeof n)e.addText(n);else if("function"==typeof n)n(e);else{if("object"!=typeof n)throw"(NList) Untractable feature types were found";switch(Object.getPrototypeOf(n)?.constructor){case HookBindInfo:e.addChild(n);break;case NTagName:if(t!=n.tagName)throw"(NList) The feature tagName does not match the element";break;case NStyle:case NAttr:case NEvent:case NAsse:n.apply(e);break;case NElement:e.addChild(n);break;case NList:{const t=n;t.flatFlag?t.apply(e):e.addChild(t.getElement());break}case Array:e.addChild(NList.getElement(n));break;default:throw"(NList) Untractable feature types were found"}}}))}getTagName(){let e="";return this.list.forEach((t=>{let n="";if(t instanceof NTagName?n=t.tagName:t instanceof NList&&t.flatFlag&&(n=t.getTagName()),n)if(e){if(e!=n)throw"(NList) Multiple TagNames exist in a feature list"}else e=n})),e}getElement(){let e=this.getTagName();""==e&&(e="div");let t=getNElement(document.createElement(e));return this.apply(t),t}static flat(e){let t=new NList(e);return t.flatFlag=!0,t}static getElement(e){return new NList(e).getElement()}}const symbolKey=Symbol("NElement");class NElement{element=null;styleHooks=new Map;constructor(e){this.element=e}addChild(e){if(e instanceof NElement)this.element.appendChild(e.element);else if(e instanceof Node)this.element.appendChild(e);else if("string"==typeof e)this.addText(e);else{if(!(e instanceof HookBindInfo))throw"(NElement) Type of child node that cannot be added";{let t=null;{let n=e.getValue();t=null==n?new Comment:"string"==typeof n?new Text(n):n instanceof NElement?n.element:n,this.element.appendChild(t)}e.bindToCallback((e=>{if(t instanceof Text&&"string"==typeof e)t.data=e;else{let n=null==e?new Comment:"string"==typeof e?new Text(e):e instanceof NElement?e.element:e;this.element.replaceChild(n,t),t=n}})).bindDestroy(this)}}}addChilds(...e){e.forEach((e=>{Array.isArray(e)?e.forEach((e=>this.addChild(e))):"object"==typeof e&&this.addChild(e)}))}insChild(e,t){let n=this.element;"number"==typeof t?t>=0||t<n.childElementCount?n.insertBefore(e.element,n.children[t]):t<0||t>=-n.childElementCount?n.insertBefore(e.element,n.children[n.childElementCount+t]):n.appendChild(e.element):n.insertBefore(e.element,t.element)}childInd(e){let t=-1;return forEach(this.element.children,((n,a)=>{if(n==e.element)return t=a,!0})),t}remove(){this.element.remove()}removeChilds(e=0,t=1/0){let n=this.element;t>n.childElementCount&&(t=n.childElementCount);for(let a=e;a<t;a++)n.children[e].remove()}getChilds(){return Array.from(this.element.children).map((e=>getNElement(e)))}getChild(e){return getNElement(this.element.children[e])}replaceWith(...e){this.element.replaceWith(...e.map((e=>e.element)))}setStyle(e,t,n){n!=this.styleHooks.get(e)&&(this.styleHooks.get(e)?.destroy(),null!=n?this.styleHooks.set(e,n):this.styleHooks.delete(e)),t instanceof HookBindInfo?t.bindToCallback((t=>{this.setStyle(e,t,n)})).bindDestroy(this).emit():this.element.style[e]=t}getStyle(e){if("string"==typeof e)return this.element.style[e]}setStyles(e){forEach(Object.keys(e),(t=>{this.setStyle(t,e[t])}))}setText(e){this.element.innerText=e}addText(e){return this.element.appendChild(document.createTextNode(e))}setAttr(e,t){this.element.setAttribute(e,t)}setAttrs(e){forEach(Object.keys(e),(t=>{this.setAttr(t,e[t])}))}setDisplay(e){this.setStyle("display",e)}addEventListener(e,t,n){this.element.addEventListener(e,t,n)}removeEventListener(e,t,n){this.element.removeEventListener(e,t,n)}animate(e,t){return this.element.animate(e,t)}async animateCommit(e,t){if("forwards"!=(t="number"==typeof t?{duration:t,fill:"forwards"}:Object.assign({fill:"forwards"},t)).fill&&"both"!=t.fill)throw"(NElelemt) animateCommit can only be used when fill forwards or both";let n=this.element.animate(e,t);await n.finished;let a=null;try{n.commitStyles()}catch(e){a=e}n.cancel(),null!=a&&console.error(a)}asse(e){return e(this),this}getTagName(){return this.element.tagName.toLowerCase()}applyNList(e){return(e instanceof NList?e:NList.flat(e)).apply(this),this}static byElement(e){return e[symbolKey]?e[symbolKey]:e instanceof NElement?e:e[symbolKey]=new NElement(e)}}function getNElement(e){return NElement.byElement(e)}const cssG={diFull:e=>"calc(100% - "+e+")",rgb:(e,t,n,a=1)=>"rgba("+e+", "+t+", "+n+", "+a+")"};function expEle(e){let t=getNElement(document.createElement(e.tagName?e.tagName:"div"));return["height","width","position","top","left","right","bottom","display","overflow"].forEach((n=>{e[n]&&t.setStyle(n,e[n])})),e.style&&t.setStyles(e.style),e.text&&t.setText(e.text),e.attr&&t.setAttrs(e.attr),e.classList&&t.element.classList.add(...e.classList),e.event&&Object.keys(e.event).forEach((n=>{e.event[n]&&t.addEventListener(n,e.event[n])})),e.child&&e.child.forEach((e=>{e&&(e instanceof NElement?t.addChild(e):t.addChild(expEle(e)))})),e.assembly&&e.assembly.forEach((e=>{let n=e(t);n&&(t=n)})),t}function preC(e,t){let n={},a={};return Object.keys(t).forEach((e=>n[e]=t[e])),Object.keys(e).forEach((i=>{if("child"!=i)if("$"==i[0]){let l=i.slice(1);a[l]=t[l],n[l]=t[l]=e[i]}else if("$"==i.slice(-1)){let n=i.slice(0,-1);a[n]=t[n],t[n]=e[i]}else n[i]=e[i]})),n.left&&n.right&&n.width&&delete n.width,n.top&&n.bottom&&n.height&&delete n.height,e.child&&(n.child=[],e.child.forEach((e=>{e&&(e instanceof NElement?n.child.push(e):n.child.push(preC(e,t)))}))),Object.keys(a).forEach((e=>t[e]=a[e])),n}function expandElement(e){return expEle(preC(e,{}))}let keyNameTable=new Map([["~","`"],["!","1"],["@","2"],["#","3"],["$","4"],["%","5"],["^","6"],["&","7"],["*","8"],["(","9"],[")","0"],["_","-"],["+","="],["{","["],["}","]"],["|","\\"],['"',"'"],[":",";"],["<",","],[">","."],["?","/"]]);const capitalA="A".charCodeAt(0),lowercaseA="a".charCodeAt(0);for(let e=0;e<26;e++)keyNameTable.set(String.fromCharCode(capitalA+e),String.fromCharCode(lowercaseA+e));new FinalizationRegistry((e=>{e.destroy()}));const storageContext={config:{},data:{history:[],favorite:[]}};async function configStorageRead(){try{let e=localStorage.getItem("config");if(!e)return;let t=JSON.parse(e);Object.keys(t).forEach((e=>{storageContext.config[e]=t[e]}))}catch(e){console.error(e)}}async function dataStorageRead(){try{let e=localStorage.getItem("config");if(!e)return;let t=JSON.parse(e);Object.keys(t).forEach((e=>{storageContext.data[e]=t[e]}))}catch(e){console.error(e)}}async function dataStorageSave(){try{let e=JSON.stringify(storageContext.data);localStorage.setItem("config",e)}catch(e){console.error(e)}}function registHistory(e,t,n,a,i,l){let o=storageContext.data.history.findIndex((t=>t[0]==e));if(-1==o)for(storageContext.data.history.unshift([e,t,n,a,i,l]);storageContext.data.history.length>150;)storageContext.data.history.pop();else 0==o?storageContext.data.history[0]=[e,t,n,a,i,l]:(storageContext.data.history.splice(o,1),storageContext.data.history.unshift([e,t,n,a,i,l]));let s=storageContext.data.favorite.find((t=>t[2]==e));s&&(s[3]=t,s[4]=n,s[5]=a,s[6]=i,s[7]=l),dataStorageSave()}function removeHistory(e){let t=storageContext.data.history.findIndex((t=>t[0]==e));-1!=t&&(storageContext.data.history.splice(t,1),dataStorageSave())}function registFavorite(e,t,n,a,i,l,o,s){let r=storageContext.data.favorite.findIndex((e=>e[2]==n));-1!=r?storageContext.data.favorite[r]=[e,t,n,a,i,l,o,s]:storageContext.data.favorite.unshift([e,t,n,a,i,l,o,s]),dataStorageSave()}function removeFavorite(e){let t=storageContext.data.favorite.findIndex((t=>t[2]==e));-1!=t&&(storageContext.data.favorite.splice(t,1),dataStorageSave())}let body=getNElement(document.body);body.setStyles({margin:"0",width:"100%",height:"100%",backgroundColor:"rgb(0, 0, 0)",position:"relative"});let styleElement=document.createElement("style");function buttonAsse(e){e.setStyle("transition","transform 50ms linear, text-shadow 150ms linear"),e.addEventListener("mousedown",(()=>{e.setStyle("transform","scale(0.95) translateY(2px)")})),e.addEventListener("mouseup",(()=>{e.setStyle("transform","")})),e.addEventListener("mouseenter",(()=>{e.setStyle("textShadow",`0 0 0.3em ${cssG.rgb(255,255,255,.5)}`),e.setStyle("transform","translateY(-1px)")})),e.addEventListener("mouseleave",(()=>{e.setStyle("textShadow",""),e.setStyle("transform","")}))}function showInfoBox(e,t,n=!1,...a){return new Promise((i=>{let l,o=expandElement({width:"100%",height:"100%",left:"0",top:"0",$position:"absolute",style:{userSelect:"none",backgroundColor:cssG.rgb(0,0,0,.7),alignItems:"center",justifyContent:"center",zIndex:"30001"},assembly:[e=>{e.animate([{opacity:.1},{opacity:1}],{duration:120})}],display:"flex",child:[{style:{border:"1px white solid",backgroundColor:cssG.rgb(255,255,255,.95),color:cssG.rgb(0,0,0),alignItems:"center",justifyContent:"center",flexFlow:"column",lineHeight:"35px",minHeight:"190px",minWidth:"280px",maxWidth:"95%",maxHeight:"95%",boxSizing:"border-box",padding:"20px",borderRadius:"7px",pointerEvents:"none"},assembly:[e=>{e.animate([{transform:"scale(0.9) translateY(-100px)"},{}],{duration:120}),setTimeout((()=>{e.setStyle("pointerEvents","auto")}),120)},e=>{l=e}],position$:"static",display:"flex",child:[{text:e},{text:t,style:{overflow:"auto",alignSelf:"stretch",display:"flex",alignItems:"center",flexDirection:"column"}},...a,{text:"确定",assembly:[buttonAsse],event:{click:()=>{s(),i(!0)}}},n?{text:"取消",assembly:[buttonAsse],event:{click:()=>{s(),i(!1)}}}:null]}]});function s(){l.setStyle("pointerEvents","none"),l.animate([{},{transform:"scale(0.9) translateY(-100px)"}],{duration:120,fill:"forwards"}),o.animate([{opacity:1},{opacity:.1}],{duration:120,fill:"forwards"}),setTimeout((()=>{o.remove()}),120)}body.addChild(o)}))}async function showInputBox(e,t,n=!1,a=""){let i=expandElement({tagName:"input",assembly:[buttonAsse],style:{textAlign:"center",margin:"15px"},attr:{value:a}});return i.addEventListener("keydown",(e=>{e.stopPropagation()}),!0),setTimeout((()=>i.element.focus()),100),await showInfoBox(e,t,n,i)?i.element.value:void 0}function showMenu(e){return new Promise((t=>{var n=null,a=NList.getElement([createNStyleList({width:"100%",height:"100%",position:"absolute",userSelect:"none",backgroundColor:cssG.rgb(0,0,0,.7),alignItems:"center",justifyContent:"center",zIndex:"30001",display:"flex"}),e=>{e.animate([{opacity:.1},{opacity:1}],{duration:120})},new NEvent("click",i),[createNStyleList({border:"1px white solid",backgroundColor:cssG.rgb(255,255,255,.95),color:cssG.rgb(0,0,0),alignItems:"stretch",justifyContent:"center",flexFlow:"column",lineHeight:"45px",minHeight:"10px",minWidth:"280px",maxHeight:"100%",maxWidth:"95%",boxSizing:"border-box",padding:"10px",borderRadius:"7px",pointerEvents:"none",overflow:"auto"}),e=>n=e,new NEvent("click",(e=>{e.stopPropagation()})),...e,e=>{e.animate([{transform:"scale(0.9) translateY(-100px)"},{}],{duration:120}),setTimeout((()=>{e.setStyle("pointerEvents","auto")}),120),e.getChilds().forEach((e=>{e.addEventListener("click",i),buttonAsse(e)}))}]]);function i(){n.setStyle("pointerEvents","none"),n.animate([{},{transform:"scale(0.9) translateY(-100px)"}],{duration:120,fill:"forwards"}),a.animate([{opacity:1},{opacity:.1}],{duration:120,fill:"forwards"}),setTimeout((()=>{a.remove()}),120)}body.addChild(a)}))}styleElement.textContent=["html","{","margin: 0;","width: 100%;","height: 100%;","}"].join(""),body.addChild(styleElement),(()=>{configStorageRead(),dataStorageRead();let e=null,t=null,n=null,a=null,i=null,l=null;function o(e,t,n,a,i,l){return NList.getElement([createNStyleList({height:"4.5em",width:"100%",padding:"5px",borderBottom:"1px solid rgba(200, 200, 200, 0.45)"}),[e],[t,createNStyleList({fontSize:"0.8em"})],[n,createNStyleList({fontSize:"0.8em"})],[a,createNStyleList({fontSize:"0.8em"})],new NEvent("click",i),new NEvent("contextmenu",(e=>{e.preventDefault(),l()}))])}function s(n,a=0){const i="im1907.top"===location.host;const l=i?"https://m1-z2.cloud.vving.vip:2223":"https://z1.m1907.top";u=n,f="",g=0,t=null,e.setAttr("src",`${l}/?jx=${encodeURIComponent(n)}`)}body.addChild(NList.getElement([createNStyleList({position:"absolute",top:"0",left:"0",width:"100%",height:"100%",color:"rgb(255, 255, 255)"}),[e=>{n=e},createNStyleList({position:"absolute",height:"100%",top:"0",width:"280px",left:"0",backgroundColor:"rgb(25, 25, 25)",userSelect:"none"}),...(()=>{let e=[],t=[{title:"播放记录",page:[e=>{i=e}]},{title:"收藏夹",page:[e=>{l=e}]}],n=0;return e.push([createNStyleList({position:"absolute",display:"flex",top:"0",height:"45px",left:"0",width:"100%",flexDirection:"row",justifyContent:"space-around",alignItems:"center",fontSize:"1.2em"}),...t.map(((t,a)=>[t.title,createNStyleList({padding:"5px"}),new NEvent("click",(async()=>{if(a==n)return;let t=e[1+n];await t.animateCommit([{opacity:"1"},{opacity:"0"}],200),t.setDisplay("none");let i=e[1+a];i.setDisplay("block"),await i.animateCommit([{opacity:"0"},{opacity:"1"}],200),n=a}))]))]),t.forEach(((t,a)=>{e.push(NList.getElement([createNStyleList({position:"absolute",top:"45px",bottom:"0",left:"0",width:"100%",backgroundColor:"rgba(70, 70, 70, 0.3)",display:a==n?"block":"none",overflowY:"auto",overflowX:"hidden"}),NList.flat(t.page)]))})),e})()],[e=>{a=e},createNStyleList({position:"absolute",height:"100%",top:"0",left:"280px",right:"0"}),[t=>{e=t},new NTagName("iframe"),new NAttr("allow","autoplay; encrypted-media"),new NAttr("allowfullscreen",""),new NEvent("load",((n,a)=>{t=e.element.contentWindow})),createNStyleList({position:"absolute",width:"100%",height:"100%",border:"none"})]]]));let r=!1;function c(e){e!=r&&(r=e,e?(n.setStyles({top:"",bottom:"0",height:"65%",left:"0",width:"100%"}),a.setStyles({top:"0",height:"35%",left:"0",right:"",width:"100%"})):(n.setStyles({top:"0",bottom:"",height:"100%",left:"0",width:"280px"}),a.setStyles({top:"0",height:"100%",left:"280px",right:"0",width:""})))}function d(){i.removeChilds(),storageContext.data.history.forEach((e=>{i.addChild(o(e[1],e[2],new Date(e[3]).toLocaleString(),0!=e[5]?(e[4]/e[5]*100).toFixed(0)+"%":"",(()=>{0!=e[5]?s(e[0],e[4]/e[5]):s(e[0])}),(()=>{showMenu([["删除",new NEvent("click",(t=>{removeHistory(e[0]),d()}))]])})))}))}let h=-1,m="";c(body.element.clientHeight>body.element.clientWidth),d(),function e(){l.removeChilds();let t=createNStyleList({width:"100%",height:"1.9em",display:"flex",flexDirection:"row",justifyContent:"space-around",alignItems:"center",borderBottom:"1px solid rgba(200, 200, 200, 0.45)"});l.addChilds([NList.getElement([new NTagName("select"),createNStyleList({width:"100%",height:"2.4em"}),...[{name:"所有收藏夹",value:"-1"},{name:"未分类",value:"0"},{name:"想看",value:"1"},{name:"在看",value:"2"},{name:"已看",value:"3"}].map((e=>[new NTagName("option"),e.name,new NAttr("value",e.value)])),e=>{e.element.value=String(h)},new NEvent("change",((t,n)=>{h=Number(n.element.value),e()}))]),NList.getElement([new NTagName("select"),createNStyleList({width:"100%"，height:"2.4em"}),...[{name:"所有标签",value:""},...Array.from(new Set(storageContext.data。favorite。map((e=>e[1])))。values())。filter((e=>""!=e))。map((e=>({name:e,value:e})))]。map((e=>[new NTagName("option"),e.name，new NAttr("value",e.value)]))，e=>{e.element.value=String(m)}，new NEvent("change"，((t，n)=>{m=String(n.element。value)，e()}))]),NList.getElement(["添加到收藏",t,new NEvent("click"，(()=>{""!=u&&(registFavorite(-1!=h?h:0,m,u,u,f,Date.now()，0,0)，e())}))]),NList.getElement(["手动添加",t,new NEvent("click"，(async()=>{let t=await showInputBox("手动添加收藏"，"请输入内容名称",!0);null!=t&&""!=t&&(registFavorite(-1!=h?h:0,m,t,t,"",Date.now()，0,0)，e())}))])]),storageContext.data。favorite。forEach((t=>{-1!=h&&t[0]!=h||""!=m&&t[1]!=m||l.addChild(o(t[3],t[4]，new Date(t[5])。toLocaleString()，["未分类"，"想看","在看"，"已看"][t[0]]+(t[1]?` / ${t[1]}`:"")，(()=>{0!=t[7]?s(t[2],t[6]/t[7]):s(t[2])})，(()=>{showMenu([0!=t[0]?["移动到未分类"，new NEvent("click"，(()=>{registFavorite(0,...t.slice(1))，e()}))]:null，1!=t[0]?["移动到想看"，new NEvent("click"，(()=>{registFavorite(1,...t.slice(1))，e()}))]:null，2!=t[0]?["移动到在看"，new NEvent("click"，(()=>{registFavorite(2,...t.slice(1))，e()}))]:null，3!=t[0]?["移动到已看"，new NEvent("click"，(()=>{registFavorite(3,...t.slice(1))，e()}))]:null，["编辑标签"+(""!=t[1]?`(${t[1]})`:"")，new NEvent("click"，(async()=>{let n=await showInputBox("编辑标签"，"更改标签名用于筛选收藏夹",!0,t[1]);null!=n&&(registFavorite(t[0],n,...t.slice(2))，e())}))]，["删除收藏夹"，new NEvent("click"，(async()=>{await showInfoBox("删除收藏夹"，`确定删除 ${t[3]} 吗?`,!0)&&(removeFavorite(t[2])，e())}))]])})))}))}();let u=""，f="",g=0，y=""，p=""，b=0;setInterval((()=>{c(body.element。clientHeight>body.element。clientWidth),t?.postMessage&&(t.postMessage({type:"getPlayInfo"}，"*")，""!=u&&registHistory(u,u,f,Date.now(),Math.round(100*g)，100),(y!=u||p!=f||0==b&&0!=g||Math.abs(g-b)>.01)&&(y=u,p=f,b=g,d()))})，3e3),window.addEventListener("message"，(e=>{let t=e.data;if("object"==typeof t)switch(t.type){case"retPlayInfo":String(t.title),String(t.episode),Number(t.playedSeconds)，Number(t.totalSeconds);break;case"name":u=t.name,f="",g=0;break;case"title":{f=t.title,g=0;let e=u+" ";f?.startsWith?.(e)&&(f=f.slice(e.length));break}case"progress":g=t.progress}})),s("")})();
